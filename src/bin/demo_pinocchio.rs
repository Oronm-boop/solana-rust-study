use std::mem;

// =================================================================
// ğŸ¤¥ Pinocchio é£æ ¼æ¼”ç¤ºï¼šé›¶æ‹·è´ä¸å†…å­˜æ˜ å°„
// =================================================================
// æ³¨æ„ï¼šä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°æ¨¡æ‹Ÿå†…å­˜ç¯å¢ƒï¼Œè€Œä¸æ˜¯çœŸçš„å»è°ƒç”¨ Solana BPFã€‚
// æ ¸å¿ƒåŸç†æ˜¯ä¸€æ ·çš„ï¼šæŠŠä¸€æ®µå­—èŠ‚æ•°ç»„ (Raw Bytes) ç›´æ¥"çœ‹ä½œ"æ˜¯ç»“æ„ä½“ã€‚

// 1. å®šä¹‰æ•°æ®ç»“æ„ (å¿…é¡»æ˜¯ repr(C) æˆ– packed)
// -----------------------------------------------------------------
// Pinocchio ä¸åƒ Anchor é‚£æ ·ç”¨ Borsh åºåˆ—åŒ– (é‚£éœ€è¦å¤åˆ¶å†…å­˜)ã€‚
// å®ƒè¦æ±‚ç»“æ„ä½“åœ¨å†…å­˜é‡Œçš„å¸ƒå±€æ˜¯å›ºå®šçš„ã€‚
#[repr(C)]
#[derive(Debug)]
struct GameState {
    health: u64, // 8 bytes
    mana: u64,   // 8 bytes
    level: u8,   // 1 byte
    is_alive: u8,// 1 byte
    padding: [u8; 6], // è¡¥é½ 8 å­—èŠ‚å¯¹é½ (8+8+1+1+6 = 24 bytes)
}

fn main() {
    println!("=== Pinocchio Zero-Copy Demo ===");

    // 2. æ¨¡æ‹Ÿé“¾ä¸Šæ•°æ® (Raw Bytes)
    // -----------------------------------------------------------------
    // å‡è®¾è¿™æ˜¯ä»åŒºå—é“¾è´¦æˆ·é‡Œè¯»å‡ºæ¥çš„ä¸€å¨åŸå§‹å­—èŠ‚ã€‚
    // åœ¨ Anchor é‡Œï¼Œæˆ‘ä»¬ä¼šç”¨ try_from_slice æŠŠè¿™å¨å­—èŠ‚ "å¤åˆ¶" è½¬æ¢æˆ structã€‚
    // ä½†åœ¨ Pinocchio é‡Œï¼Œæˆ‘ä»¬è¦ç›´æ¥æ“ä½œè¿™å¨å­—èŠ‚ï¼
    
    // åˆå§‹åŒ–ä¸€æ®µå…¨ä¸º 0 çš„å†…å­˜
    let mut account_data = [0u8; 24]; 

    // å‡è®¾è¿™æ˜¯åˆå§‹æ•°æ®ï¼šHP=100, Mana=50, Level=1, Alive=1
    // æ‰‹åŠ¨å¡«å……æ¨¡æ‹Ÿä¸€ä¸‹
    account_data[0..8].copy_from_slice(&100u64.to_le_bytes());
    account_data[8..16].copy_from_slice(&50u64.to_le_bytes());
    account_data[16] = 1; // Level
    account_data[17] = 1; // Alive


    // 3. â­ï¸ æ ¸å¿ƒé­”æ³•ï¼šæŒ‡é’ˆç±»å‹è½¬æ¢ (Transmute / Pointer Cast)
    // -----------------------------------------------------------------
    // æˆ‘ä»¬ä¸éœ€è¦ clone æ•°æ®ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªæ–°çš„ "è§†è§’"ã€‚
    // æˆ‘ä»¬å‘Šè¯‰ç¼–è¯‘å™¨ï¼šâ€œæŠŠè¿™å— [u8] å†…å­˜åŒºåŸŸï¼Œå½“æˆ GameState ç»“æ„ä½“æ¥çœ‹å¾…â€ã€‚
    
    let state: &mut GameState = unsafe {
        // 1. è·å–å­—èŠ‚æ•°ç»„çš„æŒ‡é’ˆ
        let ptr = account_data.as_mut_ptr();
        
        // 2. å¼ºåˆ¶è½¬æ¢ä¸º GameState æŒ‡é’ˆ
        let state_ptr = ptr as *mut GameState;
        
        // 3. è½¬æ¢ä¸º Rust å¼•ç”¨ (è§£å¼•ç”¨)
        &mut *state_ptr
    };

    println!(">> [Before] è¯»å–åˆ°çš„çŠ¶æ€: {:?}", state);


    // 4. é›¶å¼€é”€ä¿®æ”¹
    // -----------------------------------------------------------------
    // æˆ‘ä»¬ç›´æ¥ä¿®æ”¹ state çš„å­—æ®µã€‚
    // å› ä¸º state æœ¬è´¨ä¸Šå°±æ˜¯æŒ‡å‘ account_data é‚£å—å†…å­˜çš„æŒ‡é’ˆï¼Œ
    // æ‰€ä»¥æˆ‘ä»¬æ”¹ stateï¼Œåº•å±‚çš„ account_data å­—èŠ‚ä¹Ÿå°±å˜äº†ï¼
    
    println!("\n>> [Action] å—ä¼¤æ‰£è¡€ (-10 HP)...");
    state.health -= 10;
    
    println!(">> [After] ä¿®æ”¹åçš„çŠ¶æ€: {:?}", state);


    // 5. éªŒè¯åº•å±‚å­—èŠ‚æ˜¯å¦æ”¹å˜
    // -----------------------------------------------------------------
    // è®©æˆ‘ä»¬çœ‹çœ‹åŸå§‹çš„ byte æ•°ç»„å˜æˆäº†ä»€ä¹ˆæ ·ã€‚
    // HP çš„å‰ 8 å­—èŠ‚åº”è¯¥æ˜¯ 90 (0x5A)
    println!("\n>> [Verify] æ£€æŸ¥åº•å±‚ Raw Bytes:");
    println!("   Byte[0] (HP LSB): {}", account_data[0]); 
    
    if account_data[0] == 90 {
        println!("âœ… æˆåŠŸï¼ä¿®æ”¹ Struct ç­‰äºç›´æ¥ä¿®æ”¹äº†å†…å­˜å­—èŠ‚ï¼æ—  Copyï¼");
    } else {
        println!("âŒ å¤±è´¥ï¼æ•°æ®æ²¡æœ‰åŒæ­¥ã€‚");
    }

    // æ‰“å°å†…å­˜å¤§å°æ¯”è¾ƒ
    println!("\n------------------------------------------------");
    println!("Size of GameState: {} bytes", mem::size_of::<GameState>());
    println!("Size of Account Data: {} bytes", account_data.len());
}

// *
//  * âš ï¸ è­¦å‘Šï¼š
//  * Unsafe Rust æå…¶å±é™©ã€‚
//  * 1. å†…å­˜å¯¹é½ (Alignment): å¦‚æœ account_data çš„åœ°å€ä¸æ˜¯ 8 å­—èŠ‚å¯¹é½çš„ï¼ŒCPU å¯èƒ½ä¼šå´©æºƒã€‚
//  * 2. å­—èŠ‚åº (Endianness): åŒºå—é“¾é€šå¸¸æ˜¯ Little Endianï¼Œx86/ARM ä¹Ÿæ˜¯ï¼Œä½†è·¨å¹³å°è¦æ³¨æ„ã€‚
//  * 3. è¶Šç•Œè®¿é—®: å¿…é¡»ç¡®ä¿ account_data çš„é•¿åº¦ >= GameState çš„å¤§å°ã€‚
//  *
//  * Pinocchio åº“å…¶å®å°è£…å¥½äº†è¿™äº› unsafe æ“ä½œï¼Œæä¾›äº† `try_from_bytes` ç­‰è¾…åŠ©å‡½æ•°ï¼Œ
//  * è®©ä½ æ—¢èƒ½äº«å—é›¶æ‹·è´çš„å¿«ï¼Œåˆèƒ½ç›¸å¯¹å®‰å…¨åœ°å¼€å‘ã€‚
//
